name: Push NuGet Package

on:
    push:
        tags:
            - "v*"

env:
    DOTNET_VERSION: '10.0.x'

jobs:
    push-nuget:
        name: Build,Pack and Push NuGet Package
        runs-on: ubuntu-latest
        
        steps:
            -   name: Checkout code
                uses: actions/checkout@v5

            -   name: Setup .NET
                uses: actions/setup-dotnet@v4
                with:
                    dotnet-version: ${{ env.DOTNET_VERSION }}

            -   name: Get version from tag
                id: get_version
                run: echo "PACKAGE_VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

            -   name: Restore
                run: dotnet restore

            -   name: Build
                run: dotnet build -c Release --no-restore -p:Version=$PACKAGE_VERSION

            -   name: Pack
                run: dotnet pack -c Release --no-build -p:Version=$PACKAGE_VERSION -o to_push_packs

            -   name: Push to NuGet
                run: dotnet nuget push to_push_packs/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate

            -   name: Show pushed packs
                run: ls -1 to_push_packs